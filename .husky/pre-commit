#!/bin/sh
set -e  # Exit immediately if any command fails

echo "ğŸ” Running pre-commit checks..."

# Run lint-staged for linting and formatting
echo "ğŸ“ Running linting and formatting..."
if ! npx lint-staged; then
  echo "âŒ Linting failed!"
  exit 1
fi

# Check if there are any staged files that need testing
if git diff --cached --name-only | grep -E "(frontend/.*\.(ts|tsx|js|jsx)|backend/.*\.go)$" > /dev/null; then
  echo "ğŸ§ª Running tests..."
  
  # Run frontend tests if frontend files changed
  if git diff --cached --name-only | grep "frontend/" > /dev/null; then
    echo "ğŸ” Running frontend tests..."
    if ! npm run test:frontend; then
      echo "âŒ Frontend tests failed!"
      exit 1
    fi
  fi
  
  # Run backend tests if backend files changed
  if git diff --cached --name-only | grep "backend/" > /dev/null; then
    echo "ğŸ” Running backend tests..."
    if ! npm run test:backend; then
      echo "âŒ Backend tests failed!"
      exit 1
    fi
  fi
else
  echo "â„¹ï¸  No code changes detected, skipping tests."
fi

echo "âœ… Pre-commit checks passed!"
